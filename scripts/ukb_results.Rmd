---
output: html_document
title: "UKB results for ipgs proof-of-concept study"
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F,warning = F, 
                      dpi = 150, fig.path = "../output/ukb_results/",
                      cache.path = "../cache/ukb_results/")
suppressMessages(silent <- lapply(
  c("knitr", "kableExtra", "tidyverse", "patchwork"), 
  library, character.only = TRUE))
theme_set(theme_bw())
```

```{r load-data}
ukb_subset_names <- c("training", "validation", "testing")
ukb_subset_names_clean <- c("Training", "Validation", "Testing")
ukb_subsets <- map(set_names(ukb_subset_names), function(set) {
  read_csv(paste0("../data/processed/ukb_", set, "_set.csv"), show_col_types = FALSE) %>%
    mutate(across(matches("^gPC"), ~ . * bmi, .names = "bmiBy{.col}"),
           across(matches("^gPC"), ~ . * whr, .names = "whrBy{.col}"))
})

ancestry_df <- read_csv("../data/processed/ukb_phenos_panUKBB.csv", 
                        col_select = c(id, ancestry), show_col_types = FALSE)
ancestries <- unique(ancestry_df$ancestry[!is.na(ancestry_df$ancestry)])
```

```{r configuration}
exposures <- c("bmi")
exposures_clean <- c("BMI")

outcomes <- c("hscrp_log", "hba1c", "ldl_statinadj", "tg_log", "alt_log", 
              "ggt_log", "hdl", "alb", "lipA_log", "vitD", "apoA", 
              "apoB_statinadj", "ast_log", "chol_statinadj", "creatinine", 
              "cysC_log", "bilirubin_dir_log", "glu", "shbg", "bilirubin_tot_log")
outcomes_clean <- c("log(hsCRP)", "HbA1c", "LDL-C", "log(TG)", "log(ALT)",
                    "log(GGT)", "HDL-C", "Albumin", "log(LipA)", "Vitamin D",
                    "ApoA", "ApoB", "log(AST)", "Cholesterol", "Creatinine",
                    "log(cystatin C)", "log(Bilirubin-Direct)", "Glucose", 
                    "SHBG", "log(Bilirubin-Total)")

threshold_vec <- c(5e-8, 1e-7, 5e-7, 1e-6, 5e-6, 1e-5, 5e-5, 1e-4, 5e-4,
                   1e-3, 5e-3, 0.01, 0.05)
threshold_names <- paste0("Pt_", c("5e-08", "1e-07", "5e-07", "1e-06", "5e-06", 
                                   "1e-05", "5e-05", "0.0001", "0.0005", "0.001",
                                   "0.005", "0.01", "0.05"))
threshold_names_clean <- c("P<5e-8", "P<1e-7", "P<5e-7", "P<1e-6", "P<5e-6", 
                           "P<1e-5", "P<5e-5", "P<1e-4", "P<5e-4", "P<0.001",
                           "P<0.005", "P<0.01", "P<0.05")

pgs_types <- c("mpgs", "ipgs", "vpgs")
pgs_types_clean <- c("mPGS", "iPGS", "vPGS")

pgs_config_df <- expand_grid(
  e = exposures,
  y = outcomes,
  pgs_type = pgs_types,
  set = names(ukb_subsets),
  thresh_name = threshold_names
) %>%
  mutate(tag = case_when(
    pgs_type == "mpgs" ~ paste0(y),
    pgs_type == "ipgs" ~ paste0(e, "_", y),
    pgs_type == "vpgs" ~ paste0(y, "_vQTL")
  ))
```

```{r n-eff}
bm_pca <- select(ukb_subsets$training, outcomes) %>%
  mutate(across(everything(), ~ ifelse(is.na(.x), mean(.x, na.rm = TRUE), .x))) %>%
  prcomp(scale. = TRUE)
bm_eigenvals <- bm_pca$sdev ** 2
n_eff_bm <- sum(bm_eigenvals) ** 2 / sum(bm_eigenvals ** 2)
```

# Project summary

```{r workflow-diagram}
knitr::include_graphics("../doc/workflow_diagram.pdf")
```

Overall dataset consists of European-ancestry individuals from the UKBB (based on Pan-UKBB; N ~ 320,000).

* 50% training set: GWAS/GWIS
* 25% validation set: PGS parameter optimization
* 25% testing set: evaluation

Primary metric for evaluation (optimization & testing): significance of regression PGSxE term

Variables being manipulated:

* Exposure: BMI
* Outcomes: 20 cardiometabolic biomarkers
* PGS type: mPGS, iPGS, vPGS
* PGS name/threshold: 0.05, 0.005, ..., 5e-08

# Data distributions

Plots reflect the testing set.

```{r histograms, fig.asp=0.5, out.width="30%"}
plot_histogram <- function(f) {
  ukb_subsets$testing %>%
    select(x = {{ f }}) %>%
    filter(!is.na(x)) %>%
    ggplot(aes(x = x)) +
    geom_histogram(stat = "bin", bins = 30) +
    labs(x = f)
}

for (outcome in outcomes) {
  print(plot_histogram(outcome))
}
```

# PGS optimization

```{r stacking, eval = FALSE}
get_stack_weights <- function(e, y, tag, thresh_names, pheno_df) {
  pgs_df <- read_csv(paste0("../data/processed/pgs/", tag, "_all_pgs.csv"),
                     show_col_types = FALSE)
  df <- pheno_df %>%
    inner_join(pgs_df, by = "id") %>%
    filter(!is.na(!! sym(e)), !is.na(!! sym(y)))
  me_lm_str <- paste0(y, " ~ ", e, " + ", paste(thresh_names, collapse = " + "))
  me_lm_fit <- lm(as.formula(me_lm_str), data = df, na.action = na.exclude)
  me_lm_resids <- resid(me_lm_fit)
  scaled_pgs_mat <- df %>%
    select(all_of(thresh_names)) %>%
    mutate(across(everything(), ~ ifelse(all(.x == 0), 0, scale(.x)))) %>%
    as.matrix()
  gxe_mat <- scaled_pgs_mat * df[[e]]  # Column-wise multiplication
  gxe_fit_cv <- glmnet::cv.glmnet(gxe_mat, me_lm_resids,
                                  alpha = 0, lower.limits = 0, nfolds = 5)
  weights <- coef(gxe_fit_cv, s = "lambda.min")[thresh_names, ]
  weights_norm <- weights / sum(weights)
  weights_norm
}

calc_stacked_pgs <- function(df, weights) {
  scaled_pgs_mat <- df %>%
    select(all_of(names(weights))) %>%
    mutate(across(everything(), scale)) %>%
    as.matrix()
  stacked_pgs <- scaled_pgs_mat %*% weights
  stacked_pgs
}

stack_weights_df <- pgs_config_df %>%
  rowwise() %>%
  mutate(stack_weights = list(get_stack_weights(e, y, tag, thresh_names, ukb_subsets$validation))) %>%
  ungroup()
```

```{r pgs-testing-prep}
read_pgs <- function(tag) {
  pgs_df <- read_csv(paste0("../data/processed/pgs/", tag, "_all_pgs.csv"), 
                     show_col_types = FALSE)
  pgs_df
}

read_pgs_prsice <- function(tag) {
  pgs_df <- read_delim(paste0("../data/processed/pgs/", tag, ".all_score"), 
                       delim = " ", show_col_types = FALSE) %>%
    select(-FID, id = IID, everything())
  pgs_df
}

test_pgs_marginal <- function(y, tag, set, thresh_name, covars = NULL, standardize = TRUE) {
  pgs_df <- read_pgs_prsice(tag)
  # if (thresh_name == "stacked") {
  #   stack_weights <- pull(filter(stack_weights_df, tag == .env$tag), stack_weights)[[1]]
  #   pgs_df$stacked <- calc_stacked_pgs(pgs_df, stack_weights)
  # }
  pgs_df <- select(pgs_df, id, pgs = {{thresh_name}})
  regression_df <- inner_join(ukb_subsets[[set]], pgs_df, by = "id")
  if (standardize) {
    regression_df <- mutate(regression_df, 
                            across(all_of(c(y, "pgs")), ~ as.vector(scale(.x))))
  }
  lm_form_str <- paste0(y, " ~ pgs")
  if (!is.null(covars)) {
    lm_form_str <- paste0(lm_form_str, " + ", paste(covars, collapse = " + "))
  }
  tryCatch({
    lm_fit <- lm(as.formula(lm_form_str), data = regression_df)
    lm_fit %>%
      broom::tidy() %>%
      filter(term == "pgs")
  }, error = function(e) tibble())
}

test_pgs_gxe <- function(e, y, tag, set, thresh_name, covars = NULL, 
                         include_mPGS = FALSE,
                         include_E_sq = FALSE, include_PGS_sq = FALSE,
                         robust_SE = FALSE, standardize = TRUE,
                         ancestry_test = "all") {
  # pgs_df <- read_csv(paste0("../data/processed/pgs/", tag, "_all_pgs.csv"), 
  #                    show_col_types = FALSE)
  # if (thresh_name == "stacked") {
  #   stack_weights <- pull(filter(stack_weights_df, tag == .env$tag), stack_weights)[[1]]
  #   pgs_df$stacked <- calc_stacked_pgs(pgs_df, stack_weights)
  # }
  
  pgs_df <- tryCatch({
    pgs_df <- read_pgs_prsice(tag)
    pgs_df <- select(pgs_df, id, pgs = {{thresh_name}})
    regression_df <- inner_join(ukb_subsets[[set]], pgs_df, by = "id")
    if (standardize) {
      regression_df <- mutate(regression_df, 
                              across(all_of(c(e, y, "pgs")), ~ as.vector(scale(.x))))
    }
    if (ancestry_test != "all") {
      regression_df <- inner_join(regression_df, ancestry_df, by = "id") %>%
        filter(ancestry == ancestry_test)
    }
  }, error = function(e) tibble())
  lm_form_str <- paste0(y, " ~ pgs * ", e)
  if (!is.null(covars)) {
    lm_form_str <- paste0(lm_form_str, " + ", paste(covars, collapse = " + "))
  }
  if (include_mPGS) {
    mpgs_thresh <- pull(filter(optimal_pgs_marginal_df, .data$y == !!y), thresh_name) 
    mpgs_df <- read_pgs_prsice(y)
    mpgs_df <- select(mpgs_df, id, mpgs = {{mpgs_thresh}})
    regression_df <- left_join(regression_df, mpgs_df, by = "id")
    lm_form_str <- paste0(lm_form_str, " + mpgs")
  }
  if (include_E_sq) {
    regression_df$E_sq <- regression_df[[e]] ** 2
    lm_form_str <- paste0(lm_form_str, " + E_sq")
  } 
  if (include_PGS_sq) {
    regression_df$PGS_sq <- regression_df$pgs ** 2
    lm_form_str <- paste0(lm_form_str, " + PGS_sq")
  } 
  tryCatch({
    lm_fit <- lm(as.formula(lm_form_str), data = regression_df)
    if (robust_SE) {
      lm_fit <- lmtest::coeftest(lm_fit, vcov = sandwich::vcovHC, type = "HC0")
    }
    lm_fit %>%
      broom::tidy() %>%
      filter(term == paste0("pgs:", e))
  }, error = function(e) tibble())
}

gPCs <- paste0("gPC", 1:10)
primary_covars <- c("sex", "age", "age_squared", "ageBySex", gPCs)
```

## Positive control: GWAS and PGS main effects

```{r pgs-main-results, cache=1}
pgs_test_main_res_df <- pgs_config_df %>%
  filter(pgs_type == "mpgs") %>%
  select(y, pgs_type, tag, set, thresh_name) %>%
  distinct() %>%
  rowwise() %>%
  mutate(lm_fit = list(test_pgs_marginal(y, tag, set, thresh_name, primary_covars))) %>%
  ungroup() %>%
  unnest(lm_fit)

optimal_pgs_marginal_df <- pgs_test_main_res_df %>%
  filter(set == "validation") %>%
  group_by(y, pgs_type) %>%
  slice(which.max(abs(statistic))) %>%
  ungroup() %>%
  mutate(optimal = TRUE) %>%
  select(y, pgs_type, thresh_name, optimal)
```

We first show the results from a "standard" PGS pipeline, using summary statistics from GWAS and evaluating performance based on the PGS main effect. This acts as a positive control and illustrates the flow of the pipeline across training, optimization, and testing sets.

```{r plot-pgs-main-results, fig.asp=0.5}
pgs_test_main_plt_df <- pgs_test_main_res_df %>%
  left_join(optimal_pgs_marginal_df, by = c("y", "pgs_type", "thresh_name")) 
pgs_test_main_plt_df %>%
  filter(y == "hscrp_log") %>%
  mutate(color = if_else(set == "validation", optimal, NA),
         statistic = if_else(set == "testing" & optimal == FALSE, NA, statistic),
         y = factor(y, levels = outcomes, labels = outcomes_clean),
         set = factor(set, levels = ukb_subset_names, 
                      labels = ukb_subset_names_clean),
         thresh_name = factor(thresh_name, 
                              levels = threshold_names,
                              labels = threshold_names_clean)) %>%
  ggplot(aes(x = thresh_name, y = statistic, color = color)) +
  geom_bar(stat = "identity") +
  scale_color_discrete(name = "Optimal", na.translate = FALSE) +
  facet_wrap(vars(set), nrow = 1, ncol = 3, scale = "free_y") +
  labs(x = "", y = "PGS main effect z-statistic",
       title = "Example for log(hsCRP)") +
  theme(axis.text.x = element_text(angle = 25, hjust = 0.9))

pgs_test_main_plt_df %>%
  filter(set == "testing",
         optimal == TRUE) %>%
  mutate(Biomarker = outcomes_clean[match(y, outcomes)],
         z = round(statistic, 1)) %>%
  select(Biomarker, optimal_thres = thresh_name, z) %>%
  arrange(desc(z)) %>%
  kable(caption = "mPGS main effects for all biomarkers") %>%
  kable_styling(full_width = FALSE)
```

## PGS optimization for PGSxE

```{r mpgs-results, cache=1}
mpgs_test_res_df <- pgs_config_df %>%
  filter(pgs_type == "mpgs") %>%
  rowwise() %>%
  mutate(lm_fit = list(test_pgs_gxe(e, y, tag, set, thresh_name, 
                                    c(primary_covars, paste0(e, "By", gPCs))))) %>%
  ungroup() %>%
  unnest(lm_fit)

optimal_mpgs_df <- mpgs_test_res_df %>%
  filter(set == "validation") %>%
  group_by(e, y) %>%
  slice(which.max(abs(statistic))) %>%
  ungroup() %>%
  mutate(optimal = TRUE) %>%
  select(e, y, pgs_type, thresh_name, optimal)
```

```{r plot-mpgs-results, fig.width=10}
mpgs_test_res_df %>%
  filter(set == "validation") %>%
  left_join(optimal_mpgs_df, by = c("e", "y", "pgs_type", "thresh_name")) %>%
  mutate(y = factor(y, levels = outcomes, labels = outcomes_clean),
         thresh_name = factor(thresh_name, 
                              levels = threshold_names,
                              labels = threshold_names_clean)) %>%
  ggplot(aes(x = thresh_name, y = statistic, color = optimal)) +
  geom_bar(stat = "identity") +
  scale_color_discrete(name = "Optimal", na.translate = FALSE) +
  facet_wrap(vars(y, e), ncol = 5, scale = "free_y") +
  labs(x = "", y = "mPGS GxE z-statistic",
       title = "Optimization of mPGS for PGSxE") +
  theme(axis.text.x = element_text(angle = 35, hjust = 0.9))
```

```{r ipgs-results, cache=1}
ipgs_test_res_df <- pgs_config_df %>%
  filter(pgs_type == "ipgs") %>%
  rowwise() %>%
  mutate(lm_fit = list(test_pgs_gxe(e, y, tag, set, thresh_name, 
                                    c(primary_covars, paste0(e, "By", gPCs))))) %>%
  ungroup() %>%
  unnest(lm_fit)

# e <- "whr"
# y <- "hba1c"
# tag <- "whr_hba1c"
# pheno_df <- ukb_subsets$validation

optimal_ipgs_df <- ipgs_test_res_df %>%
  filter(set == "validation") %>%
  group_by(e, y) %>%
  slice(which.max(abs(statistic))) %>%
  ungroup() %>%
  mutate(optimal = TRUE) %>%
  select(e, y, pgs_type, thresh_name, optimal)
```

```{r plot-ipgs-results, fig.width=10}
ipgs_test_res_df %>%
  filter(set == "validation") %>%
  left_join(optimal_ipgs_df, by = c("e", "y", "pgs_type", "thresh_name")) %>%
  mutate(y = factor(y, levels = outcomes, labels = outcomes_clean),
         thresh_name = factor(thresh_name, 
                              levels = threshold_names,
                              labels = threshold_names_clean)) %>%
  ggplot(aes(x = thresh_name, y = statistic, color = optimal)) +
  geom_bar(stat = "identity") +
  scale_color_discrete(name = "Optimal", na.translate = FALSE) +
  facet_wrap(vars(y), ncol = 5, scale = "free_y") +
  labs(x = "", y = "iPGS GxE z-statistic",
       title = "Optimization of iPGS for PGSxBMI") +
  theme(axis.text.x = element_text(angle = 35, hjust = 0.9))
```

```{r vpgs-results, cache=1}
vpgs_test_res_df <- pgs_config_df %>%
  filter(pgs_type == "vpgs") %>%
  rowwise() %>%
  mutate(lm_fit = list(test_pgs_gxe(e, y, tag, set, thresh_name, 
                                    c(primary_covars, paste0(e, "By", gPCs))))) %>%
  ungroup() %>%
  unnest(lm_fit)

optimal_vpgs_df <- vpgs_test_res_df %>%
  filter(set == "validation") %>%
  group_by(e, y) %>%
  slice(which.max(abs(statistic))) %>%
  ungroup() %>%
  mutate(optimal = TRUE) %>%
  select(e, y, pgs_type, thresh_name, optimal)
```

```{r plot-vpgs-results, fig.width=10}
vpgs_test_res_df %>%
  filter(set == "validation") %>%
  left_join(optimal_vpgs_df, by = c("e", "y", "pgs_type", "thresh_name")) %>%
  mutate(y = factor(y, levels = outcomes, labels = outcomes_clean),
         thresh_name = factor(thresh_name, 
                              levels = threshold_names,
                              labels = threshold_names_clean)) %>%
  ggplot(aes(x = thresh_name, y = statistic, color = optimal)) +
  geom_bar(stat = "identity") +
  scale_color_discrete(name = "Optimal", na.translate = FALSE) +
  facet_wrap(vars(y), ncol = 5, scale = "free_y") +
  labs(x = "", y = "vPGS GxE z-statistic",
       title = "Optimization of vPGS for PGSxBMI") +
  theme(axis.text.x = element_text(angle = 35, hjust = 0.9))
```


```{r joint-pgs, cache=1, eval=F}
train_jpgs <- function(e, y, set = "validation", covars = NULL) {
  mpgs_thresh <- filter(optimal_mpgs_df, .data$y == !!y)$thresh_name
  mpgs_df <- read_pgs_prsice(y) %>%
    select(id, mpgs = {{mpgs_thresh}})
  ipgs_thresh <- filter(optimal_ipgs_df, .data$y == !!y)$thresh_name
  ipgs_df <- read_pgs_prsice(paste0(e, "_", y)) %>%
    select(id, ipgs = {{ipgs_thresh}})
  vpgs_thresh <- filter(optimal_vpgs_df, .data$y == !!y)$thresh_name
  vpgs_df <- read_pgs_prsice(paste0(y, "_vQTL")) %>%
    select(id, vpgs = {{vpgs_thresh}})
  pgs_df <- mpgs_df %>%
    inner_join(ipgs_df, by = "id") %>%
    inner_join(vpgs_df, by = "id")
  regression_df <- ukb_subsets[[set]] %>%
    inner_join(pgs_df, by = "id")
  lm_form_str <- paste0(y, " ~ mpgs * ", e, " + ipgs * ", e, " + vpgs * ", e)
  lm_fit <- lm(as.formula(lm_form_str), data = regression_df)
  fitted_weights <- lm_fit %>%
    broom::tidy() %>%
    filter(grepl(":", term)) %>%
    pull(estimate) %>%
    setNames(c("mpgs", "ipgs", "vpgs"))
  sd_norm_weights <- sapply(c("mpgs", "ipgs", "vpgs"), function(pgs_type) {
    pgs_sd <- sd(pgs_df[[pgs_type]])
    fitted_weights[pgs_type] * pgs_sd
  }, USE.NAMES = FALSE)
  relative_weights <- sd_norm_weights / sum(abs(sd_norm_weights))
  list(
    pgs_df = pgs_df,
    fitted_weights = fitted_weights,
    relative_weights = relative_weights
  )
}

test_jpgs_gxe <- function(e, y, set, covars = NULL, 
                         include_E_sq = FALSE, robust_SE = FALSE, standardize = TRUE,
                         ancestry_test = "all") {
  train_jpgs_obj <- train_jpgs(e, y, covars = covars)
  pgs_mat <- as.matrix(select(train_jpgs_obj$pgs_df, -id))
  jpgs <- pgs_mat %*% train_jpgs_obj$fitted_weights
  jpgs_df <- tibble(id = train_jpgs_obj$pgs_df$id, pgs = jpgs)
  regression_df <- ukb_subsets[[set]] %>%
    inner_join(jpgs_df, by = "id")
  if (standardize) {
    regression_df <- mutate(regression_df, 
                            across(all_of(c(e, y, "pgs")), ~ as.vector(scale(.x))))
  }
  if (ancestry_test != "all") {
    regression_df <- inner_join(regression_df, ancestry_df, by = "id") %>%
      filter(ancestry == ancestry_test)
  }
  lm_form_str <- paste0(y, " ~ pgs * ", e)
  if (!is.null(covars)) {
    lm_form_str <- paste0(lm_form_str, " + ", paste(covars, collapse = " + "))
  }
  if (include_E_sq) {
    regression_df$E_sq <- regression_df[[e]] ** 2
    lm_form_str <- paste0(lm_form_str, " + E_sq")
  } 
  lm_res <- tryCatch({
    lm_fit <- lm(as.formula(lm_form_str), data = regression_df)
    if (robust_SE) {
      lm_fit <- lmtest::coeftest(lm_fit, vcov = sandwich::vcovHC, type = "HC0")
    }
    lm_fit %>%
      broom::tidy() %>%
      filter(term == paste0("pgs:", e))
  }, error = function(e) tibble())
  list(
    lm_res = lm_res, 
    fitted_weights = train_jpgs_obj$fitted_weights,
    relative_weights = train_jpgs_obj$relative_weights
  )
}

jpgs_test_res_df <- tibble(e = "bmi", y = outcomes) %>%
  rowwise() %>%
  mutate(lm_fit = list(test_jpgs_gxe(e, y, "testing",
                                     c(primary_covars, paste0(e, "By", gPCs))))) %>%
  ungroup() %>%
  unnest_wider(lm_fit, simplify = FALSE) %>%
  unnest(lm_res)
```
```{r plot-jpgs-weights, fig.asp=0.4, fig.width=8, eval=F}
jpgs_test_res_df %>%
  select(y, relative_weights) %>%
  unnest_longer(relative_weights, indices_to = "pgs_subtype") %>%
  mutate(y = factor(y, levels = outcomes, labels = outcomes_clean),
         pgs_subtype = factor(pgs_subtype, levels = pgs_types, 
                              labels = pgs_types_clean)) %>%
  ggplot(aes(x = y, y = relative_weights, fill = pgs_subtype)) +
  geom_bar(stat = "identity", width = 0.8, position = position_dodge()) +
  geom_vline(xintercept = seq(1.5, length(outcomes) - 0.5, by = 1), 
             color = "black", linetype = "solid", size = 0.2) +
  scale_fill_discrete(name = "PGS subtype") +
  labs(x = "Biomarker", y = "PGS subtype importance for jointPGS") +
  theme(axis.text.x = element_text(angle = 35, hjust = 0.9))
```

# PGS performance

## Testing of optimized PGS

```{r collect-pgs-results-1}
all_pgs_test_res_df <- bind_rows(
  inner_join(mpgs_test_res_df, optimal_mpgs_df),
  inner_join(ipgs_test_res_df, optimal_ipgs_df),
  inner_join(vpgs_test_res_df, optimal_vpgs_df)
  # mutate(jpgs_test_res_df, pgs_type = "jpgs", set = "testing")
)

n_biomarkers <- length(outcomes)
bonferroni <- 0.05 / n_eff_bm

outcomes_ordered <- all_pgs_test_res_df %>%
  filter(set == "testing") %>%
  arrange(p.value) %>%
  distinct(y) %>%
  pull(y)

all_pgs_test_plt_df <- all_pgs_test_res_df %>%
  filter(set == "testing") %>%
  mutate(e = factor(e, levels = exposures, labels = exposures_clean),
         y = factor(y, levels = outcomes_ordered),
         y = fct_relabel(y, ~ outcomes_clean[match(., outcomes)]),
         pgs_type = factor(pgs_type, levels = c(pgs_types, "jpgs"), 
                           labels = c(pgs_types_clean, "jointPGS")),
         set = factor(set, levels = names(ukb_subsets), 
                      labels = paste0(str_to_title(names(ukb_subsets)), " set")),
         thresh_name = factor(thresh_name, 
                              levels = threshold_names,
                              labels = threshold_names_clean))
```

```{r plot-all-pgs-results, fig.asp=1}
all_pgs_test_plt_df %>%
  ggplot(aes(x = pgs_type, y = statistic, fill = pgs_type)) +
  geom_bar(stat = "identity") +
  geom_hline(yintercept = 0, color = "gray") +
  geom_hline(yintercept = qnorm(bonferroni / 2, lower.tail = FALSE), linetype = "dashed") +
  scale_fill_discrete(name = "PGS type") +
  facet_wrap(vars(y), ncol = 4, scale = "fixed") +
  labs(x = "", y = "Interaction test z-statistic",
       title = "PGSxE testing (testing set)") +
  # coord_cartesian(ylim = c(-7, 15)) +
  theme(axis.text.x = element_text(angle = 20, hjust = 0.9))
```

```{r expanded-pgs-results}
bm_level_summary_df <- all_pgs_test_res_df %>%
  filter(set == "testing",
         pgs_type != "jpgs") %>%
  group_by(y) %>%
  summarise(any_nom = any(p.value < 0.05),
            any_bonf = any(p.value < bonferroni))

all_pgs_test_res_df %>%
  filter(set == "testing",
         pgs_type != "jpgs",
         p.value < bonferroni) %>%
  group_by(y) %>%
  summarise(top_pgs_type = pgs_type[which.max(abs(statistic))],
            .groups = "drop") %>%
  group_by(top_pgs_type) %>%
  summarise(n = n(),
            biomarkers = paste(unique(y), collapse = ", "),
            .groups = "drop") %>%
  arrange(desc(n)) %>%
  select(`Top PGS type` = top_pgs_type, N = n, Biomarkers = biomarkers) %>%
  kable(caption = "Top-performing PGS type per biomarker (of those with any Bonferroni significant PGS)") %>%
  kable_styling(full_width = FALSE)

all_pgs_test_res_df %>%
  filter(set == "testing",
         pgs_type != "jpgs") %>%
  arrange(desc(abs(statistic))) %>%
  select(y, pgs_type, thresh_name, estimate, statistic, p.value) %>%
  mutate(p.value = as.character(signif(p.value, 3))) %>%
  head(10) %>%
  kable(caption = "Top PGSxE tests") %>%
  kable_styling()

# bmi_y_corr_df <- expand_grid(
#   y = outcomes
# ) %>%
#   rowwise() %>%
#   mutate(corr = cor.test(ukb_subsets$testing$bmi, ukb_subsets$testing[[y]])$estimate) %>%
#   ungroup() %>%
#   select(y, corr) %>%
#   arrange(desc(corr))
# 
# all_pgs_test_res_df %>%
#   filter(set == "testing") %>%
#   inner_join(bmi_y_corr_df, by = "y") %>%
#   select(y, pgs_type, p.value, corr) %>%
#   arrange(desc(corr)) %>%
#   group_by(y) %>%
#   summarise(ipgs_better = p.value[pgs_type == "mpgs"] / p.value[pgs_type == "ipgs"],
#             corr = corr[1]) %>%
#   arrange(desc(ipgs_better))
```

```{r plot-all-pgs-results-with-jpgs, fig.asp=1}
all_pgs_test_res_df %>%
  filter(set == "testing") %>%
  mutate(e = factor(e, levels = exposures, labels = exposures_clean),
         y = factor(y, levels = outcomes_ordered),
         y = fct_relabel(y, ~ outcomes_clean[match(., outcomes)]),
         pgs_type = factor(pgs_type, levels = c(pgs_types, "jpgs"), 
                           labels = c(pgs_types_clean, "jointPGS")),
         set = factor(set, levels = names(ukb_subsets), 
                      labels = paste0(str_to_title(names(ukb_subsets)), " set")),
         thresh_name = factor(thresh_name, 
                              levels = threshold_names,
                              labels = threshold_names_clean),
         l95 = estimate - 1.96 * std.error,
         u95 = estimate + 1.96 * std.error) %>%
  ggplot(aes(x = pgs_type, y = estimate, color = pgs_type)) +
  # geom_bar(stat = "identity") +
  geom_point() +
  geom_errorbar(aes(ymin = l95, ymax = u95), width = 0.2) +
  geom_hline(yintercept = 0, color = "gray") +
  scale_fill_discrete(name = "PGS type") +
  facet_wrap(vars(y), ncol = 4, scale = "fixed") +
  labs(x = "", y = "Interaction effect estimate (95% CI)",
       title = "PGSxE testing (testing set)") +
  # coord_cartesian(ylim = c(-10, 10)) +
  theme(axis.text.x = element_text(angle = 20, hjust = 0.9))
```

Of the biomarkers tested, `r sum(bm_level_summary_df$any_nom)` had at least one nominally significant PGS interaction test (P < 0.05), and `r sum(bm_level_summary_df$any_bonf)` had at least one significant interaction test after Bonferroni correction (P < 0.05 / `r round(n_eff_bm, 1)` effective biomarkers).

## Sensitivity analyses

```{r prep-bmi-pgs}
pgs_bmi_main_res_df <- tibble(
  thresh_name = threshold_names
) %>%
  rowwise() %>%
  mutate(lm_fit = list(test_pgs_marginal("bmi", "bmi", "validation", thresh_name, primary_covars))) %>%
  ungroup() %>%
  unnest(lm_fit)
pgs_bmi_opt_thresh <- pgs_bmi_main_res_df %>%
  slice(which.max(abs(statistic))) %>%
  pull(thresh_name)

pgs_bmi_df <- read_pgs_prsice("bmi") %>%
  select(id, pgs_bmi = {{pgs_bmi_opt_thresh}})

ukb_subsets$testing <- ukb_subsets$testing %>%
  inner_join(pgs_bmi_df, by = "id")
```

```{r sensitivity-results, cache=1}
sensitivity_test_res_df <- all_pgs_test_res_df %>%
  filter(set == "testing",
         pgs_type != "jpgs") %>%
  select(e, y, pgs_type, set, thresh_name, tag) %>%
  rowwise() %>%
  mutate(lm_fit_eur = list(test_pgs_gxe(e, y, tag, set, thresh_name, 
                                        c(primary_covars, paste0(e, "By", gPCs)),
                                        ancestry_test = "EUR")),
         lm_fit_robust = list(test_pgs_gxe(e, y, tag, set, thresh_name, 
                                           c(primary_covars, paste0(e, "By", gPCs)),
                                           robust_SE = TRUE)),         
         lm_fit_with_mPGS = list(test_pgs_gxe(e, y, tag, set, thresh_name, 
                                              c(primary_covars, paste0(e, "By", gPCs)),
                                              include_mPGS = TRUE)),
         lm_fit_eSq = list(test_pgs_gxe(e, y, tag, set, thresh_name, 
                                        c(primary_covars, paste0(e, "By", gPCs)),
                                        include_E_sq = TRUE)),
         lm_fit_pgsSq = list(test_pgs_gxe(e, y, tag, set, thresh_name, 
                                        c(primary_covars, paste0(e, "By", gPCs)),
                                        include_PGS_sq = TRUE)),
         lm_fit_bmiPGS = list(test_pgs_gxe(e, y, "bmi", set, pgs_bmi_opt_thresh, 
                                           c(primary_covars, paste0(e, "By", gPCs)))),
         lm_fit_swap_bmi_for_bmiPGS = list(test_pgs_gxe("pgs_bmi", y, tag, set, thresh_name, 
                                                        c(primary_covars, paste0(e, "By", gPCs))))) %>%
  ungroup()
```

```{r plot-sensitivity-results, out.width="50%"}
sensitivity_test_plt_df <- bind_rows(list(
  primary = filter(all_pgs_test_res_df, set == "testing"),
  eur = unnest(sensitivity_test_res_df, lm_fit_eur),
  robust = unnest(sensitivity_test_res_df, lm_fit_robust),
  with_mPGS = unnest(sensitivity_test_res_df, lm_fit_with_mPGS),
  eSq = unnest(sensitivity_test_res_df, lm_fit_eSq),
  pgsSq = unnest(sensitivity_test_res_df, lm_fit_pgsSq),
  bmiPGS = unnest(sensitivity_test_res_df, lm_fit_bmiPGS),
  swap_bmi_for_bmiPGS = unnest(sensitivity_test_res_df, lm_fit_swap_bmi_for_bmiPGS)
), .id = "model") %>%
  filter(pgs_type == "ipgs") %>%
  select(e, y, estimate, statistic, p.value, model) %>%
  pivot_wider(names_from = model, values_from = -c(e, y))

sensitivity_test_plt_df %>%
  ggplot(aes(x = statistic_primary, y = statistic_eur)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  labs(x = "Primary model z-statistic", y = "European testing subset model z-statistic")

sensitivity_test_plt_df %>%
  ggplot(aes(x = statistic_primary, y = statistic_robust)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  labs(x = "Primary model z-statistic", y = "Robust SE model z-statistic")

sensitivity_test_plt_df %>%
  ggplot(aes(x = statistic_primary, y = statistic_eSq)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  labs(x = "Primary model z-statistic", y = "Nonlinear E model z-statistic")

sensitivity_test_plt_df %>%
  ggplot(aes(x = statistic_primary, y = statistic_pgsSq)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  labs(x = "Primary model z-statistic", y = "Nonlinear PGS model z-statistic")

sensitivity_test_plt_df %>%
  ggplot(aes(x = statistic_primary, y = statistic_bmiPGS)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  coord_cartesian(ylim = c(NA, max(sensitivity_test_plt_df$statistic_primary))) +
  labs(x = "Primary model z-statistic", y = "BMI PGS z-statistic")

sensitivity_test_plt_df %>%
  ggplot(aes(x = statistic_primary, y = statistic_with_mPGS)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  labs(x = "Primary model z-statistic", y = "mPGS-adjusted model z-statistic")

sensitivity_test_plt_df %>%
  ggplot(aes(x = statistic_primary, y = statistic_swap_bmi_for_bmiPGS)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  labs(x = "Primary model (PGS x BMI) z-statistic", y = "PGS x PGS_BMI model z-statistic")
```

# Specific visualizations - BMI and log(ALT)

```{r example-setup}
e <- "bmi"
y <- "alt_log"
tag <- "bmi_alt_log"
thresh_name <- "Pt_5e-07"
e_clean <- "BMI"
y_clean <- "log(ALT)"
pgs_df <- read_pgs_prsice(tag) %>%
  select(id, pgs = {{thresh_name}})
regression_df <- inner_join(ukb_subsets$testing, pgs_df, by = "id") %>%
  filter(!is.na(.data[[e]]), !is.na(.data[[y]])) %>%
  mutate(pgs_bin = cut(pgs, quantile(pgs, seq(0, 1, length.out = 11)), 
                       include.lowest = TRUE, labels = paste0("Q", 1:10)))
```

```{r example-e-y, out.width="30%"}
regression_df %>%
  ggplot(aes_string(x = e, y = y)) +
  geom_smooth(method = "gam", formula = y ~ rms::rcs(x, 5)) +
  labs(x = e_clean,
       y = y_clean)

print(paste0("Example E-Y corr: ", 
             round(cor(regression_df[[e]], regression_df[[y]]), 2)))
```

```{r example-main-effects, fig.asp=0.5}
pgs_test_main_res_df %>%
  left_join(optimal_pgs_marginal_df, by = c("y", "pgs_type", "thresh_name")) %>%
  filter(y == .env$y) %>%
  mutate(color = if_else(set == "validation", optimal, NA),
         statistic = if_else(set == "testing" & optimal == FALSE, NA, statistic),
         y = factor(y, levels = outcomes, labels = paste0(outcomes_clean, " set")),
         set = factor(set, levels = ukb_subset_names, 
                      labels = ukb_subset_names_clean),
         thresh_name = factor(thresh_name, 
                              levels = threshold_names,
                              labels = threshold_names_clean)) %>%
  ggplot(aes(x = thresh_name, y = statistic, color = color)) +
  geom_bar(stat = "identity") +
  scale_color_discrete(name = "Optimal", na.translate = FALSE) +
  facet_wrap(vars(set), nrow = 1, scale = "free_y") +
  labs(x = "", y = "PGS main effect z-statistic",
       title = "Positive control: standard GWAS/main effects pipeline") +
  theme(axis.text.x = element_text(angle = 25, hjust = 0.9))
```

```{r example-test, fig.width=5, fig.asp=0.5}
all_pgs_test_res_df %>%
  filter(set == "testing",
         e == .env$e,
         y == .env$y) %>%
  mutate(e = factor(e, levels = exposures, labels = exposures_clean),
         y = factor(y, levels = outcomes, labels = outcomes_clean),
         pgs_type = factor(pgs_type, levels = c(pgs_types, "jpgs"), 
                           labels = c(pgs_types_clean, "jointPGS")),
         set = factor(set, levels = names(ukb_subsets), 
                      labels = paste0(str_to_title(names(ukb_subsets)), " set")),
         thresh_name = factor(thresh_name, 
                              levels = threshold_names,
                              labels = threshold_names_clean)) %>%
  ggplot(aes(x = pgs_type, y = statistic, fill = pgs_type)) +
  geom_bar(stat = "identity") +
  geom_hline(yintercept = 0, color = "gray") +
  scale_fill_discrete(name = "PGS type") +
  labs(x = "", y = "Interaction test z-statistic",
       title = "PGSxBMI (testing set)") +
  theme(axis.text.x = element_text(angle = 20, hjust = 0.9))
```

```{r example-strat-plots, fig.asp=0.5}
quantile_lines_plt <- regression_df %>%
  ggplot(aes_string(x = e, y = y, group = "pgs_bin", color = "pgs_bin")) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "lm", formula = "y ~ x") +
  scale_color_discrete(name = "PGS bin") +
  coord_cartesian(xlim = quantile(regression_df[[e]], c(0.01, 0.99)),
                  ylim = quantile(regression_df[[y]], c(0.01, 0.99))) +
  labs(x = e_clean,
       y = y_clean)

test_ey <- function(df, e, y, covars) {
  lm_form_str <- paste0(y, " ~ ", e, " + ", paste(covars, collapse = " + "))
  lm_fit <- lm(as.formula(lm_form_str), data = df)
  lm_fit %>%
    broom::tidy() %>%
    filter(term == e)
}

quantile_effects_df <- regression_df %>%
  nest(data = -pgs_bin) %>%
  rowwise() %>%
  mutate(ey_lm = test_ey(data, e, y, primary_covars)) %>%
  select(-data) %>%
  unnest(ey_lm)
quantile_effects_plt <- quantile_effects_df %>%
  select(pgs_bin, estimate) %>%
  ggplot(aes(x = pgs_bin, y = estimate)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "gray") +
  labs(x = "PGS bin",
       y = paste0(e_clean, " - ", y_clean, " effect size"))

quantile_lines_plt + quantile_effects_plt

quantile_effects_df %>%
  arrange(pgs_bin) %>%
  select(pgs_bin, estimate) %>%
  mutate(factor_change = estimate / estimate[1],
         across(-pgs_bin, ~ round(.x, 3))) %>%
  kable(caption = "PGS-stratified BMI-risk factor effects") %>%
  kable_styling(full_width = FALSE)
```

```{r example-sensitivity}
bmi_pgs_config_df <- expand_grid(
  thresh_name = threshold_names,
  set = names(ukb_subsets)
) %>%
  mutate(pgs_type = "mpgs")

pgs_test_bmi_res_df <- bmi_pgs_config_df %>%
  select(pgs_type, set, thresh_name) %>%
  distinct() %>%
  rowwise() %>%
  mutate(lm_fit = list(test_pgs_marginal(y, "bmi", set, thresh_name, primary_covars))) %>%
  ungroup() %>%
  unnest(lm_fit)

optimal_pgs_bmi_df <- pgs_test_bmi_res_df %>%
  filter(set == "validation") %>%
  group_by(pgs_type) %>%
  slice(which.max(abs(statistic))) %>%
  ungroup() %>%
  mutate(optimal = TRUE) %>%
  select(pgs_type, thresh_name, optimal)

bmi_pgs_df <- read_pgs_prsice("bmi") %>%
  select(id, bmi_pgs = `Pt_0.05`)
regression_df <- regression_df %>%
  select(-any_of("bmi_pgs")) %>%
  inner_join(bmi_pgs_df, by = "id")

# test_pgs_gxe(e, y, tag = "bmi", "testing", "Pt_0.05", primary_covars)
# test_pgs_gxe(e, y, tag = tag, "testing", thresh_name, primary_covars)
```

# Export

```{r export-optimized-params}
optimized_mpgs_param_df <- all_pgs_test_res_df %>%
  # mutate(thresh_name = if_else(thresh_name == "Pt_0.05", "Pt_0.005", thresh_name)) %>% ###
  mutate(threshold = threshold_vec[match(thresh_name, threshold_names)]) %>%
  filter(pgs_type == "mpgs",
         e == "bmi") %>%
  distinct(y, tag, threshold) %>%
  mutate(threshold = signif(threshold, 1))
optimized_mpgs_param_df %>%
  write_csv("../data/processed/pgs/optimized_mpgs_params.csv")

optimized_ipgs_param_df <- all_pgs_test_res_df %>%
  # mutate(thresh_name = if_else(thresh_name == "Pt_0.05", "Pt_0.005", thresh_name)) %>%
  mutate(threshold = threshold_vec[match(thresh_name, threshold_names)]) %>%
  filter(pgs_type == "ipgs",
         e == "bmi") %>%
  distinct(y, tag, threshold) %>%
  mutate(threshold = signif(threshold, 1))
optimized_ipgs_param_df %>%
  write_csv("../data/processed/pgs/optimized_ipgs_params.csv")

optimized_vpgs_param_df <- all_pgs_test_res_df %>%
  # mutate(thresh_name = if_else(thresh_name == "Pt_0.05", "Pt_0.005", thresh_name)) %>%
  mutate(threshold = threshold_vec[match(thresh_name, threshold_names)]) %>%
  filter(pgs_type == "vpgs",
         e == "bmi") %>%
  distinct(y, tag, threshold) %>%
  mutate(threshold = signif(threshold, 1))
optimized_vpgs_param_df %>%
  write_csv("../data/processed/pgs/optimized_vpgs_params.csv")

# jpgs_weights_df <- all_pgs_test_res_df %>%
#   filter(pgs_type == "jpgs") %>%
#   select(y, fitted_weights) %>% unnest_wider(fitted_weights)
# write_csv(jpgs_weights_df, "../data/processed/pgs/jpgs_weights_df.csv")

bind_rows(list(mPGS = optimized_mpgs_param_df, 
               iPGS = optimized_ipgs_param_df, 
               vPGS = optimized_vpgs_param_df),
          .id = "type") %>%
  mutate(y = outcomes_clean[match(y, outcomes)]) %>%
  select(y, threshold, type) %>%
  pivot_wider(names_from = "type", values_from = "threshold") %>%
  kable(caption = "Optimized PGS thresholds") %>%
  kable_styling(full_width = FALSE)
```

```{r export-manuscript-objects}
system("mkdir -p ../data/processed/manuscript")

# Phenotypes
saveRDS(ukb_subsets, "../data/processed/manuscript/ukb_subsets.rds")
saveRDS(n_eff_bm, "../data/processed/manuscript/n_eff_bm.rds")

# PGS testing results
saveRDS(pgs_test_main_res_df, "../data/processed/manuscript/pgs_test_main_res_df.rds")
saveRDS(optimal_pgs_marginal_df, "../data/processed/manuscript/optimal_pgs_marginal_df.rds")

saveRDS(mpgs_test_res_df, "../data/processed/manuscript/mpgs_test_res_df.rds")
saveRDS(optimal_mpgs_df, "../data/processed/manuscript/optimal_mpgs_df.rds")

saveRDS(ipgs_test_res_df, "../data/processed/manuscript/ipgs_test_res_df.rds")
saveRDS(optimal_ipgs_df, "../data/processed/manuscript/optimal_ipgs_df.rds")

saveRDS(vpgs_test_res_df, "../data/processed/manuscript/vpgs_test_res_df.rds")
saveRDS(optimal_vpgs_df, "../data/processed/manuscript/optimal_vpgs_df.rds")

saveRDS(all_pgs_test_res_df, "../data/processed/manuscript/all_ukb_pgs_test_res_df.rds")

saveRDS(sensitivity_test_plt_df, "../data/processed/manuscript/sensitivity_test_plt_df.rds")
```

```{r testing, eval=F}
e <- "bmi"
y <- "hdl"
tag <- "hdl"
thresh_name <- "Pt_5e-07"
e_clean <- "BMI"
y_clean <- "HDL-C"
pgs_df <- read_pgs_prsice(tag) %>%
  select(id, pgs = {{thresh_name}})
regression_df <- inner_join(ukb_subsets$testing, pgs_df, by = "id") %>%
  filter(!is.na(.data[[e]]), !is.na(.data[[y]])) %>%
  mutate(pgs_bin = cut(pgs, quantile(pgs, seq(0, 1, length.out = 11)), 
                       include.lowest = TRUE, labels = paste0("Q", 1:10)))

regression_df %>%
  ggplot(aes(x = bmi, y = hdl)) +
  geom_smooth()
hist(regression_df$hdl)

mpgs_test_res_df %>%
  filter(y == "hdl",
         pgs_type == "mpgs",
         set == "testing")

all_pgs_test_res_df %>%
  filter(y == "hdl",
         pgs_type == "mpgs",
         set == "testing")

# a <- regression_df %>%
#   nest(data = -pgs_bin) %>%
#   rowwise() %>%
#   mutate(ey_lm = test_ey(data, e, y, primary_covars)) %>%
#   select(-data) %>%
#   unnest(ey_lm)
# a %>%
#   select(pgs_bin, estimate) %>%
#   ggplot(aes(x = pgs_bin, y = estimate)) +
#   geom_point() +
#   geom_hline(yintercept = 0, color = "gray") +
#   labs(x = "PGS bin",
#        y = paste0(e_clean, " - ", y_clean, " effect size"))
# a %>%
#   arrange(pgs_bin) %>%
#   select(pgs_bin, estimate) %>%
#   mutate(factor_change = estimate / estimate[1],
#          across(-pgs_bin, ~ round(.x, 3)))

regression_df$hdl_log <- log(regression_df$hdl)
cor.test(regression_df$pgs, regression_df$bmi)
cor.test(regression_df$pgs, regression_df[[y]])
cor.test(regression_df$pgs, regression_df[["hdl_log"]])
test_pgs_gxe(e, y, tag, "testing", primary_covars)
test_pgs_gxe(e, "hdl_log", tag, "testing", primary_covars)
```

```{r, eval=F}
test_rfs <- c("hdl", "ldl_statinadj", "bilirubin_dir_log", "tg_log", "hba1c", "shbg")
for (rf in test_rfs) {
  print(cor(regression_df$bmi, regression_df[[rf]], use = "pairwise.complete.obs"))
}

for (rf in test_rfs) {
  e <- "bmi"
  y <- rf
  tag <- rf
  thresh_name <- "Pt_5e-05"
  pgs_df <- read_pgs_prsice(tag) %>%
    select(id, pgs = {{thresh_name}})
  regression_df <- inner_join(ukb_subsets$testing, pgs_df, by = "id") %>%
    mutate(hdl_log = log(hdl)) %>%
    filter(!is.na(.data[[e]]), !is.na(.data[[y]])) %>%
    mutate(pgs_bin = cut(pgs, quantile(pgs, seq(0, 1, length.out = 11)), 
                         include.lowest = TRUE, labels = paste0("Q", 1:10)))
  # print(paste0(rf, ":"))
  # print(cor(regression_df$pgs, regression_df[[y]], use = "pairwise.complete.obs"))
}
```

