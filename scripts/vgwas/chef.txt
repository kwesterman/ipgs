#Chef file for vGWAS with QUAIL


# Run vGWAS using QUAIL
# download QUAIL from GitHub (NOTE: minor edits to Step2; see README notes, below)
git clone https://github.com/qlu-lab/QUAIL vgwas/QUAIL

# prep plinkset; filter by maf & info>0.3; (stored in scratch)
qsub -t 1-22 data_prep/prep_ukb_plinkset.sh 0.005
qsub data_prep/postprocess_ukb_plinkset.sh 0.005

# run vgwas with quail
for bm in hba1c hscrp_log; do qsub vgwas/run_vgwas.sh 0.005 ../data/processed/phenos/ukb_phenos_unrelated.csv ${bm}; done
for bm in hba1c hscrp_log; do qsub vgwas/postprocess_vgwas.sh ${bm}; done

---------------------------------------------------------------------------------------------------------------

README

* Minor edits made to original Step-2 QUAIL script on line 19: Add heading for "ERROR" in plink glm.linear output: 
** Original: colnames(df) <- c("CHR", "BP", "SNP", "REF", "ALT", "A1", "TEST", "N", "BETA", "SE", "Z", "P", "A2")
** _JEG: colnames(df) <- c("CHR", "BP", "SNP", "REF", "ALT", "A1", "TEST", "N", "BETA", "SE", "Z", "P", "ERROR", "A2")
*** The resulting file was renamed as: Step2_QUAIL_vQTL_JEG.R


* Preliminary tests for running QUAIL with the covariates listed below errored out, as follows: 
** covariates: age, sex, age_squared, ageBySex, gPC1, gPC2, gPC3, gPC4, gPC5, gPC6, gPC7, gPC8. gPC9, gPC10
	*1-produced when using 14 raw covariates*: Error: Cannot proceed with --glm regression on phenotype 'int_rank_score',
	since genotype/covariate scales vary too widely for numerical stability of the current implementation. Try rescaling your covariates 	with e.g. --covar-variance-standardize.
	** In response, '--covar-variance-standardie ' was added to the plink2 commands.

	*2-produced when using 14 raw covariates with added flag for '--covar-variance-standardize '*: Error: Cannot proceed with --glm 	regression on phenotype 'int_rank_score', since variance inflation factor for covariate 'age' is too high (VIF_TOO_HIGH).
	You may want to remove redundant covariates and try again.
	** In response, '--vif 300 ' was added to the plink2 commands (NOTE: the default is set to 50; 100 and 200 produced the same error 	messages).

*** Additional plink2 flags were added directly to the Step-2 QUAIL script on line 87:
** Original: 
# Plinlk2 to run genome-wide vQTL analysis
  job_vqtl <- paste0(plink_path, " --bfile ", genotype, " --rm-dup 'exclude-all' 'list' ", " --pheno ", pheno_rank_score , " --covar ", covariate, " --out ", output, "_QUAIL_vQTL --linear --covar-variance-standardize --vif 300 --no-psam-pheno")



	--covar-variance-standardize
	--vif 300







